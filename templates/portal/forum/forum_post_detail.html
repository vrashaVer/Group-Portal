<h1>{{ object.title }}</h1>
<p>{{ object.text }}</p>

{% if object.image %}
    <img src="{{ object.image.url }}" alt="Post Image">
{% endif %}

{% if object.video %}
    <video controls>
        <source src="{{ object.video.url }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
{% endif %}
<a href="{% url 'edit_forum_post' object.id %}" class="edit-link">Редагувати</a>
<a href="{% url 'forum_post_list' object.category.id %}" class="back-link">Назад</a>

<div class="comments-list" id="comments-list">
    {% for comment in comments %}
        <div class="comment-block {% if comment.user == request.user %}current-user{% endif %}">
            <div class="comment-header">
                <span class="comment-author">{{ comment.user.username }}</span>
                <span class="comment-date">{{ comment.created_at|date:"d M Y H:i" }}</span>
            </div>
            <p class="comment-text">{{ comment.text }}</p>
        </div>
    {% empty %}
        <p>No comments yet.</p>
    {% endfor %}
</div>

<div class="comment-form-container">
    <form id="comment-form" method="post" action="{% url 'add_comment' object.id %}" class="comment-form">
        {% csrf_token %}
        <textarea id="comment-textarea" name="text" placeholder="Write your comment here..." required></textarea>
        <button type="submit" class="btn">Submit</button>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('comment-form');
        const textarea = form.querySelector('textarea');
        const commentsList = document.getElementById('comments-list');  // список коментарів

        // Встановлюємо максимальну висоту для текстового поля
        const maxHeight = 100;

        // Функція для оновлення висоти текстового поля
        function updateTextareaHeight() {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
        }

        textarea.addEventListener('input', updateTextareaHeight);
        updateTextareaHeight();  // Ініціалізуємо висоту при завантаженні

        // Додаємо обробник події для натискання клавіші Enter
        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {  // Enter без Shift
                event.preventDefault();  // Запобігаємо переходу на новий рядок
                submitForm();  // Викликаємо AJAX-відправлення форми
            }
        });

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Запобігаємо стандартному відправленню форми
            submitForm();  // Викликаємо AJAX-відправлення форми
        });

        // Функція для відправлення форми через AJAX
        function submitForm() {
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Очищуємо текстове поле
                    textarea.value = '';
                    updateTextareaHeight();

                    // Оновлюємо список коментарів через AJAX
                    fetchComments();
                } else {
                    console.error('Error:', data.message);
                    alert('An error occurred while submitting the comment. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting the comment. Please try again.');
            });
        }

        // Функція для оновлення списку коментарів через AJAX
        function fetchComments() {
            fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.text())
            .then(html => {
                // Оновлюємо список коментарів
                const newCommentsList = new DOMParser().parseFromString(html, 'text/html')
                    .querySelector('#comments-list').innerHTML;
                commentsList.innerHTML = newCommentsList;

                // Прокручуємо список донизу
                commentsList.scrollTop = commentsList.scrollHeight;
            })
            .catch(error => {
                console.error('Error fetching comments:', error);
            });
        }


        // Оновлюємо список коментарів кожні 5 секунд
        setInterval(fetchComments, 5000);
    });

</script>